<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>Document</title>
</head>

<body>
    <h1></h1>
    <div id="container" style="width:100%; height:400px;"></div>

    <script>
        const courseCode = "CSC148H1";
        // const prof = "David Liu";
        const url = "http://localhost:8080/api/v1/evals/past";
        const termToMonth = { 'Winter': 0, 'Summer': 4, 'Fall': 8 };

        axios.get(url, { params: {course_code: courseCode } })
            .then(data => {
                let responseData = data.data;

                // Compute sessions which is like { text: "Winter 2019", date: Date(mm, dd, yyyy) }
                responseData = responseData.map(record => {
                    let month = termToMonth[record['term']];
                    let year = parseInt(record['year'])
                    return {
                        session: {
                            date: new Date(year, month, 1),
                            text: `${record['term']} ${record['year']}`
                        },
                        ...record
                    };
                });

                // Sort them based on their session
                responseData = responseData.sort((a, b) => {
                    return a.session.date - b.session.date;
                });

                // We then want to grab each unique sessions and sort the sessions
                let sessions = responseData.reduce((sessions, record) => {
                    if (sessions.length == 0 || sessions[sessions.length-1].date < record.session.date) {
                        sessions.push(record.session);
                    }
                    return sessions;
                }, []);

                // Then we want to group records based on their instructors
                responseData = responseData.reduce((groups, record) => {
                    let instructor = record.instructor;
                        
                    if (!groups.has(instructor)) {
                        groups.set(instructor, []);
                    }
                    groups.get(instructor).push(record);

                    return groups;

                }, new Map());

                // Then foreach instructor, we want to group ratings based on their session
                responseData = Array.from(responseData.keys()).reduce((groups, instructor) => {

                    let data = groups.get(instructor);
                    let sessionGroups = data.reduce((sessionGroups, record) => {
                        
                        let session = record.session.text;

                        if (!sessionGroups.has(session)) {
                            sessionGroups.set(session, []);
                        }

                        sessionGroups.get(session).push(record.ratings);

                        return sessionGroups;

                    }, new Map());

                    groups.set(instructor, sessionGroups);
                    return groups;

                }, responseData);

                // Then foreach instructor and foreach session, take the avg rating score
                responseData = Array.from(responseData.keys()).reduce((groups, instructor) => {
                    // console.log(groups);
                    // console.log(instructor);

                    let data = groups.get(instructor);
                    let sessionGroups = Array.from(data.keys()).reduce((sessionGroups, session) => {

                        // console.log(sessionGroups);
                        // console.log(session);
                        
                        let sessionRatings = sessionGroups.get(session);
                        let avgSessionRatings = [];

                        for (let j = 0; j < sessionRatings[0].length; j++) {
                            let avgRating = 0;
                            for (let i = 0; i < sessionRatings.length; i++) {
                                avgRating += sessionRatings[i][j];
                            }

                            avgRating /= sessionRatings.length;
                            avgSessionRatings.push(avgRating);
                        }
                        
                        // console.log(avgSessionRatings);
                        sessionGroups.set(session, avgSessionRatings);
                        return sessionGroups;

                    }, data);

                    groups.set(instructor, sessionGroups);
                    return groups;

                }, responseData);

                console.log(responseData);
            })
            .catch(error => {

            });

        Highcharts.chart('container', {
            chart: {
                type: 'column'
            },
            title: {
                text: 'Monthly Average Rainfall'
            },
            subtitle: {
                text: 'Source: WorldClimate.com'
            },
            xAxis: {
                categories: [
                    'Jan',
                    'Feb',
                    'Mar',
                    'Apr',
                    'May',
                    'Jun',
                    'Jul',
                    'Aug',
                    'Sep',
                    'Oct',
                    'Nov',
                    'Dec'
                ],
                crosshair: true
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Rainfall (mm)'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                    '<td style="padding:0"><b>{point.y:.1f} mm</b></td></tr>',
                footerFormat: '</table>',
                shared: true,
                useHTML: true
            },
            plotOptions: {
                column: {
                    pointPadding: 0.2,
                    borderWidth: 0
                }
            },
            series: [{
                name: 'Tokyo',
                data: [[1, 49.9], [3, 71.5], [1, 106.4]]

            }, {
                name: 'New York',
                data: [83.6, 78.8, 98.5, 93.4, 106.0, 84.5, 105.0, 104.3, 91.2, 83.5, 106.6, 92.3]

            }, {
                name: 'London',
                data: [48.9, 38.8, 39.3, 41.4, 47.0, 48.3, 59.0, 59.6, 52.4, 65.2, 59.3, 51.2]

            }, {
                name: 'Berlin',
                data: [42.4, 33.2, 34.5, 39.7, 52.6, 75.5, 57.4, 60.4, 47.6, 39.1, 46.8, 51.1]

            }]
        });
    </script>
</body>

</html>